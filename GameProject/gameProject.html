<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      #container {
        position: relative;
        width: 1000px;
        height: 600px;
        border: 1px solid black;
        overflow: hidden; /* 이미지가 바깥으로 나가지 않도록 */
      }

      #player {
        position: absolute;
        left: 70px;
        top: 536px;
      }

      #enemy {
        width: 60px;
        height: 30px;
        position: absolute;
        top: 198px;
        left: 50%;
      }

      #enemy2 {
        width: 60px;
        height: 30px;
        position: absolute;
        top: 200px;
        left: 50%;
      }

      #enemy3 {
        width: 60px;
        height: 30px;
        position: absolute;
        top: 440px;
        left: 50%;
      }

      #gameover {
        border: 1px solid;
        font-size: 3px;
        width: 270px;
        position: absolute;
        left: 300px;
        top: 150px;
        display: none;
        color: rgb(211, 214, 14);
        font: bold;
      }
      #button {
        transform: translate(60px);
      }
      #score {
        font-size: 50px;
        position: absolute;
        z-index: 1;
        color: rgb(212, 19, 19);
      }
      .sliding-background {
        position: absolute;
        background: url(backgroundMap.png);
        width: 100%;
        height: 100%;
      }
    </style>
    <script>
      $(document).ready(function () {
        var isJumping = false;

        function setKeyboardEvent() {
          // 키보드 이벤트 정의
          $("html").keydown(function (e) {
            switch (e.key) {
              case " ":
                if (!isJumping) {
                  // 점프 연타 방지
                  $("#player").stop();
                  jump();
                }
                break;
              case "ArrowLeft":
                moveLeft();
                break;
              case "ArrowRight":
                moveRight();
                break;
              case "a":
                shoot();
                break;
            }
            console.log(e.key);
            console.log($("#player").css("top"));
          });
        }
        //캐릭터가 맵의 빈곳에 위치했을때 떨어지는 효과 만들기

        function adjustPlayerPosition() {
          var player = $("#player");
          var x = parseInt(player.css("left"));
          var y = parseInt(player.css("top"));
          var currentFloor = 1; // 현재 층수 변수 추가
          if ((x >= 130 && x <= 170) || (x >= 790 && x <= 830)) {
            y = 536;
            currentFloor = 1;
          } else if (y >= 328 && y <= 444) {
            y = 418;
            currentFloor = 2;
          } else if (y >= 200 && y <= 300) {
            y = 299;
            currentFloor = 3;
          } else if (y < 198 && 165 < y) {
            y = 178;
            currentFloor = 4;
          }
          player.css("top", y + "px");

          // y값이 536일 때만 animate() 메서드를 사용하여 애니메이션 효과 적용
          /*  if (y === 536) {
                  player.animate({ top: y + "px" }, "medium");
                } else {
                  player.css("top", y + "px");
                }

       */
          return currentFloor; // 현재 층수 반환
        }

        function jump() {
          if (isJumping) {
            return;
          }
          isJumping = true;
          var player = $("#player");
          var currentFloor = adjustPlayerPosition();
          var startY = parseInt(player.css("top"));
          player.animate({ top: "-=130px" }, "fast", function () {
            var newFloor = adjustPlayerPosition();
            if (currentFloor === 4) {
              player.animate({ top: "+=130px" }, "fast");
              isJumping = false;
              return;
            } else if (newFloor !== currentFloor) {
              isJumping = false;
              return;
            }
            var endY = parseInt(player.css("top"));
            player.animate(
              { top: startY - endY + "px" },
              300,
              "swing",
              function () {
                isJumping = false;
                adjustPlayerPosition();
              }
            );
          });
          console.log(
            "캐릭터의 위치: (" +
              player.css("left") +
              ": " +
              player.css("top") +
              ")"
          );
        }

        // isJumping 변수를 적마다 독립적으로 관리하기 위한 객체 생성
        var enemyStatus = {
          enemy: { isJumping: false },
          enemy2: { isJumping: false },
          enemy3: { isJumping: false },
        };

        function enemyJump(enemy) {
          var status = enemyStatus[enemy.attr("id")];
          if (status.isJumping) {
            return;
          }
          status.isJumping = true;
          var currentFloor = adjustEnemyPosition(enemy);
          var startY = parseInt(enemy.css("top"));
          enemy.animate({ top: "-=130px" }, "fast", function () {
            var newFloor = adjustEnemyPosition(enemy);
            if (currentFloor === 4) {
              enemy.animate({ top: "+=130px" }, "fast");
              status.isJumping = false;
              return;
            } else if (newFloor !== currentFloor) {
              status.isJumping = false;
              return;
            }
            var endY = parseInt(enemy.css("top"));
            enemy.animate(
              { top: startY - endY + "px" },
              300,
              "swing",
              function () {
                status.isJumping = false;
                adjustEnemyPosition(enemy);
              }
            );
          });
          console.log(
            "적의 위치: (" + enemy.css("left") + ": " + enemy.css("top") + ")"
          );
        }

        function moveLeft() {
          var player = $("#player");
          var leftPos = parseInt(player.css("left"));
          if (leftPos > 70) {
            player.css("left", leftPos - 20);
            player.attr("src", "playerL.png");
            player.addClass("left");
            player.removeClass("right");
            console.log(
              "캐릭터의 위치: (" +
                player.css("left") +
                ": " +
                player.css("top") +
                ")"
            );
          }
          enemy;
          adjustPlayerPosition();
        }

        function moveRight() {
          var player = $("#player");
          var leftPos = parseInt(player.css("left"));
          if (leftPos < 885) {
            player.css("left", leftPos + 20);
            player.attr("src", "playerR.png");
            player.addClass("right");
            player.removeClass("left");
            console.log(
              "캐릭터의 위치: (" +
                player.css("left") +
                ": " +
                player.css("top") +
                ")"
            );
          }
          adjustPlayerPosition();
        }

        // 적 위치 이동
        // 각 적의 독립적인 이동 상태를 저장하는 객체 생성
        var enemyStatus = {
          enemy: { direction: "left", speed: 5 },
          enemy2: { direction: "right", speed: 7 },
          enemy3: { direction: "right", speed: 3 },
        };

        function moveEnemy(enemy) {
          var left = parseInt(enemy.css("left"));
          var direction = enemyStatus[enemy.attr("id")].direction; // 각 적의 독립적인 이동 방향
          var speed = enemyStatus[enemy.attr("id")].speed; // 각 적의 독립적인 이동 속도
          var width = $("#container").width();

          if (direction === "right") {
            left += speed;
            if (left > width - 80) {
              left = width - 80;
              enemyStatus[enemy.attr("id")].direction = "left"; // 이동 방향 변경
            } else if (left >= 890) {
              enemyStatus[enemy.attr("id")].direction = "left"; // 이동 방향 변경
            }
          } else {
            left -= speed;
            if (left < 0) {
              left = 0;
              enemyStatus[enemy.attr("id")].direction = "right"; // 이동 방향 변경
            } else if (left <= 70) {
              enemyStatus[enemy.attr("id")].direction = "right"; // 이동 방향 변경
            }
          }

          enemy.css("left", left + "px");
          adjustEnemyPosition(enemy);
        }

        // 난이도 조절
        setInterval(function () {
          var enemy = $("#enemy");
          var enemy2 = $("#enemy2");
          var enemy3 = $("#enemy3");

          if (Math.random() < 0.01) {
            enemyJump(enemy);
          }

          if (Math.random() < 0.01) {
            enemyJump(enemy2);
          }

          if (Math.random() < 0.01) {
            enemyJump(enemy3);
          }
          moveEnemy(enemy);
          moveEnemy(enemy2);
          moveEnemy(enemy3);
        }, 50);

        function adjustEnemyPosition(enemy) {
          var x = parseInt(enemy.css("left"));
          var y = parseInt(enemy.css("top"));
          var currentFloor = 1;

          if ((x >= 130 && x <= 170) || (x >= 790 && x <= 830)) {
            y = 556;
            currentFloor = 1;
          } else if (y >= 330 && y <= 444) {
            y = 438;
            currentFloor = 2;
          } else if (y >= 200 && y <= 325) {
            y = 318;
            currentFloor = 3;
          } else if (165 < y && y < 200) {
            y = 198;
            currentFloor = 4;
          }
          enemy.css("top", y + "px");
          enemy.data("current-floor", currentFloor); // 현재 층수 정보 저장

          return currentFloor;
        }

        function shoot() {
          var player = $("#player");
          var x = parseInt(player.css("left"));
          var y = parseInt(player.css("top"));
          var direction = player.hasClass("left") ? -1 : 1;
          var bubble = $('<img class="bubble" src="bubble.png"/>');
          bubble.css("position", "absolute");
          bubble.css(
            "left",
            player.position().left + player.width() / 2 + "px"
          );
          bubble.css("top", player.position().top + "px");
          $("#container").append(bubble);

          var bubbleX = x + direction * 200;
          var bubbleY = y; // 버블의 초기 y 좌표

          bubble.animate(
            { left: bubbleX + "px", top: bubbleY + "px" },
            500,
            function () {
              $(this).animate({ top: "-100px" }, 2000, function () {
                $(this).remove();
              });
            }
          );

          // 주기적으로 충돌 감지
          setInterval(function () {
            $(".enemy").each(function () {
              var enemy = $(this);
              if (checkCollision(bubble, enemy)) {
                enemy.remove(); // 충돌한 적 제거
              }
            });
          }, 100);
        }

        function checkCollision(obj1, obj2) {
          var obj1Pos = obj1.offset();
          var obj2Pos = obj2.offset();

          var obj1Width = obj1.width();
          var obj1Height = obj1.height();
          var obj2Width = obj2.width();
          var obj2Height = obj2.height();

          if (
            obj1Pos.left < obj2Pos.left + obj2Width &&
            obj1Pos.left + obj1Width > obj2Pos.left &&
            obj1Pos.top < obj2Pos.top + obj2Height &&
            obj1Pos.top + obj1Height > obj2Pos.top
          ) {
            return true; // 충돌 발생
          } else {
            return false; // 충돌 없음
          }
        }

        function handleClick(event) {
          var x = event.clientX;
          var y = event.clientY;
          console.log("x: " + x + ", y: " + y);

          // x 좌표가 161에서 206 사이인 경우 y 좌표를 0으로 설정

          // 캐릭터 위치 설정
          $("#player").css({ top: y + "px", left: x + "px" });
        }

        // 게임 오버 처리
        function handleGameOver() {
          $("#gameover").show();
        }

        // 충돌 감지
        function detectCollision() {
          var player = $("#player");
          var enemy = $("#enemy");
          var bubble = $(".bubble");

          var playerTop = player.position().top;
          var playerLeft = player.position().left;
          var playerRight = playerLeft + player.width();
          var playerBottom = playerTop + player.height();

          var enemyTop = enemy.position().top;
          var enemyLeft = enemy.position().left;
          var enemyRight = enemyLeft + enemy.width();

          // 충돌 검사
          if (
            playerLeft <= enemyRight &&
            playerRight >= enemyLeft &&
            playerTop <= enemyTop &&
            playerBottom >= enemyTop
          ) {
            handleGameOver();
          } // 버블과 적의 충돌 검사
          bubble.each(function () {
            var bubble = $(this);
            var bubbleTop = bubble.position().top;
            var bubbleLeft = bubble.position().left;
            var bubbleRight = bubbleLeft + bubble.width();
            var bubbleBottom = bubbleTop + bubble.height();

            if (
              bubbleLeft <= enemyRight &&
              bubbleRight >= enemyLeft &&
              bubbleTop <= enemyTop &&
              bubbleBottom >= enemyTop
            ) {
              // 적 제거
              enemy.remove();

              // 버블 제거
              bubble.remove();
            }
          });
        }

        setKeyboardEvent();

        $("#player").on("mousedown", function (event) {
          $(document).on("mousemove", function (event) {
            handleClick(event);
          });
          $(document).on("mouseup", function () {
            $(document).off("mousemove");
          });
          setInterval(function () {
            moveLeft();
            moveRight();
            detectCollision();
          }, 50);
        });

        // 게임 루프
        function gameLoop() {
          detectCollision();
          moveEnemy();
          setTimeout(gameLoop, 50);
        }

        // 게임 시작
        function startGame() {
          $("#start-button").hide();
          $("#container").show();
          gameLoop();
        }

        // 이벤트 핸들러 등록
        $("#start-button").click(startGame);
        $("#gameover button").click(function () {
          location.reload();
        });
        $("#container").click(handleClick);
      });
    </script>
  </head>
  <body>
    <div id="container">
      <div class="sliding-background"></div>
      <img id="player" src="playerR.png" alt="" />

      <img id="enemy" class="enemy" src="enemyL.png" alt="" />
      <img id="enemy2" class="enemy" src="enemyR.png" alt="" />
      <img id="enemy3" class="enemy" src="enemyR.png" alt="" />
    </div>
    <div id="gameover">
      GameOver
      <button id="button" onclick="location.reload()">확인</button>
    </div>
  </body>
</html>

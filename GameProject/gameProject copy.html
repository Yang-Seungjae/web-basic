<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      #container {
        position: relative;
        width: 1000px;
        height: 600px;
        border: 1px solid black;
        overflow: hidden; /* 이미지가 바깥으로 나가지 않도록 */
      }

      #player {
        position: absolute;
        left: 70px;
        top: 536px;
      }

      #enemy {
        width: 60px;
        height: 30px;
        position: absolute;
        top: 198px;
        left: 50%;
      }
      .enemy {
        width: 60px;
        height: 30px;
        position: absolute;
        top: 198px;
        left: 50%;
      }
      #gameover {
        border: 1px solid;
        font-size: 3px;
        width: 270px;
        position: absolute;
        left: 300px;
        top: 150px;
        display: none;
        color: rgb(211, 214, 14);
        font: bold;
      }
      #button {
        transform: translate(60px);
      }
      #score {
        font-size: 50px;
        position: absolute;
        z-index: 1;
        color: rgb(212, 19, 19);
      }
      .sliding-background {
        position: absolute;
        background: url(backgroundMap.png);
        width: 100%;
        height: 100%;
      }
    </style>
    <script>
      $(document).ready(function () {
        var isjumping = false;
        var enemyCount = 5; // 생성할 적의 수

        function setKeyboardEvent() {
          // 키보드 이벤트 정의
          $("html").keydown(function (e) {
            switch (e.key) {
              case " ":
                if (!isjumping) {
                  // 점프 연타 방지
                  $("#player").stop();
                  jump();
                }
                break;
              case "ArrowLeft":
                moveLeft();
                break;
              case "ArrowRight":
                moveRight();
                break;
              case "a":
                shoot();
                break;
            }
            console.log(e.key);
            console.log($("#player").css("top"));
          });
        }
        //캐릭터가 맵의 빈곳에 위치했을때 떨어지는 효과 만들기

        function adjustPlayerPosition() {
          var player = $("#player");
          var x = parseInt(player.css("left"));
          var y = parseInt(player.css("top"));
          var currentFloor = 1; // 현재 층수 변수 추가
          if ((x >= 130 && x <= 170) || (x >= 790 && x <= 830)) {
            y = 536;
            currentFloor = 1;
          } else if (y >= 328 && y <= 444) {
            y = 418;
            currentFloor = 2;
          } else if (y >= 200 && y <= 300) {
            y = 299;
            currentFloor = 3;
          } else if (y < 198 && 165 < y) {
            y = 178;
            currentFloor = 4;
          }
          player.css("top", y + "px");

          // y값이 536일 때만 animate() 메서드를 사용하여 애니메이션 효과 적용
          /*  if (y === 536) {
                  player.animate({ top: y + "px" }, "medium");
                } else {
                  player.css("top", y + "px");
                }

       */
          return currentFloor; // 현재 층수 반환
        }

        var isJumping = false;

        function jump() {
          if (isJumping) {
            return;
          }
          isJumping = true;
          var player = $("#player");
          var currentFloor = adjustPlayerPosition();
          var startY = parseInt(player.css("top"));
          player.animate({ top: "-=130px" }, "fast", function () {
            var newFloor = adjustPlayerPosition();
            if (currentFloor === 4) {
              player.animate({ top: "+=130px" }, "fast");
              isJumping = false;
              return;
            } else if (newFloor !== currentFloor) {
              isJumping = false;
              return;
            }
            var endY = parseInt(player.css("top"));
            player.animate(
              { top: startY - endY + "px" },
              300,
              "swing",
              function () {
                isJumping = false;
                adjustPlayerPosition();
              }
            );
          });
          console.log(
            "캐릭터의 위치: (" +
              player.css("left") +
              ": " +
              player.css("top") +
              ")"
          );
        }

        function enemyJump(enemy) {
          if (isJumping) {
            return;
          }
          isJumping = true;
          var currentFloor = adjustEnemyPosition(enemy);
          var startY = parseInt(enemy.css("top"));
          enemy.animate({ top: "-=130px" }, "fast", function () {
            var newFloor = adjustEnemyPosition(enemy);
            if (currentFloor === 4) {
              enemy.animate({ top: "+=130px" }, "fast");
              isJumping = false;
              return;
            } else if (newFloor !== currentFloor) {
              isJumping = false;
              return;
            }
            var endY = parseInt(enemy.css("top"));
            enemy.animate(
              { top: startY - endY + "px" },
              300,
              "swing",
              function () {
                isJumping = false;
                adjustEnemyPosition(enemy);
              }
            );
          });
          console.log(
            "적의 위치: (" + enemy.css("left") + ": " + enemy.css("top") + ")"
          );
        }

        function moveLeft() {
          var player = $("#player");
          var leftPos = parseInt(player.css("left"));
          if (leftPos > 70) {
            player.css("left", leftPos - 20);
            player.attr("src", "playerL.png");
            player.addClass("left");
            player.removeClass("right");
            console.log(
              "캐릭터의 위치: (" +
                player.css("left") +
                ": " +
                player.css("top") +
                ")"
            );
          }
          enemy;
          adjustPlayerPosition();
        }

        function moveRight() {
          var player = $("#player");
          var leftPos = parseInt(player.css("left"));
          if (leftPos < 885) {
            player.css("left", leftPos + 20);
            player.attr("src", "playerR.png");
            player.addClass("right");
            player.removeClass("left");
            console.log(
              "캐릭터의 위치: (" +
                player.css("left") +
                ": " +
                player.css("top") +
                ")"
            );
          }
          adjustPlayerPosition();
        }

        // 적 위치 이동
        function moveEnemy() {
          $(".enemy:not(.hidden)").each(function () {
            var enemy = $(this);
            var left = parseInt(enemy.css("left"));
            var direction = enemy.data("direction");
            var speed = parseFloat(enemy.data("speed"));
            var width = $("#container").width();

            if (direction === "right") {
              left += speed;
              if (left > width - 80) {
                left = width - 80;
                enemy.data("direction", "left");
              } else if (left >= 890) {
                enemy.data("direction", "left");
              }
            } else {
              left -= speed;
              if (left < 0) {
                left = 0;
                enemy.data("direction", "right");
              } else if (left <= 70) {
                enemy.data("direction", "right");
              }
            }
            enemy.css("left", left + "px");
            adjustEnemyPosition(enemy);
          });
        }

        function adjustEnemyPosition(enemy) {
          var x = parseInt(enemy.css("left"));
          var y = parseInt(enemy.css("top"));
          var currentFloor = 1;

          if ((x >= 130 && x <= 170) || (x >= 790 && x <= 830)) {
            y = 556;
            currentFloor = 1;
          } else if (y >= 330 && y <= 444) {
            y = 438;
            currentFloor = 2;
          } else if (y >= 200 && y <= 325) {
            y = 318;
            currentFloor = 3;
          } else if (165 < y && y < 200) {
            y = 198;
            currentFloor = 4;
          }
          enemy.css("top", y + "px");
          enemy.data("current-floor", currentFloor); // 현재 층수 정보 저장

          return currentFloor;
        }

        function shoot() {
          var player = $("#player");
          var x = parseInt(player.css("left"));
          var y = parseInt(player.css("top"));
          var direction = player.hasClass("left") ? -1 : 1;
          var bubble = $('<img class="bubble" src="bubble.png"/>');
          bubble.css("position", "absolute");
          bubble.css(
            "left",
            player.position().left + player.width() / 2 + "px"
          );
          bubble.css("top", player.position().top + "px");
          $("#container").append(bubble);
          var bubbleX = x + direction * 300;
          bubble.animate({ left: bubbleX + "px" }, 500, function () {
            $(this).animate({ top: "-100px" }, 2000, function () {
              $(this).remove();
            });
          });
        }

        function handleClick(event) {
          var x = event.clientX;
          var y = event.clientY;
          console.log("x: " + x + ", y: " + y);

          // x 좌표가 161에서 206 사이인 경우 y 좌표를 0으로 설정

          // 캐릭터 위치 설정
          $("#player").css({ top: y + "px", left: x + "px" });
        }

        // 게임 오버 처리
        function handleGameOver() {
          $("#gameover").show();
        }

        function detectCollision() {
          var player = $("#player");
          $(".enemy:not(.hidden)").each(function () {
            var enemy = $(this);

            var playerTop = player.position().top;
            var playerLeft = player.position().left;
            var playerRight = playerLeft + player.width();
            var playerBottom = playerTop + player.height();

            var enemyTop = enemy.position().top;
            var enemyLeft = enemy.position().left;
            var enemyRight = enemyLeft + enemy.width();

            if (
              playerLeft <= enemyRight &&
              playerRight >= enemyLeft &&
              playerTop <= enemyTop &&
              playerBottom >= enemyTop
            ) {
              handleGameOver();
            }
          });
        }
        setKeyboardEvent();

        $("#player").on("mousedown", function (event) {
          $(document).on("mousemove", function (event) {
            handleClick(event);
          });
          $(document).on("mouseup", function () {
            $(document).off("mousemove");
          });
          setInterval(function () {
            moveLeft();
            moveRight();
            detectCollision();
          }, 50);
        });
        // 게임 루프
        function gameLoop() {
          detectCollision();
          moveEnemy();
          setTimeout(gameLoop, 50);
        }

        // 난이도 조절
        setInterval(function () {
          if (Math.random() < 1) {
            enemyJump($("#enemy"));
            enemyJump($("#enemy1"));
            enemyJump($("#enemy2"));
          }
          moveEnemy();
        }, 50);
        // 게임 시작

        function startGame() {
          $("#start-button").hide();
          $("#container").show();
          showEnemies();
          gameLoop();
          setInterval(showEnemies, 2000);
          setInterval(moveEnemy, 100); // 적들의 움직임을 처리할 함수를 주기적으로 호출
        }
        // 이벤트 핸들러 등록
        $("#start-button").click(startGame);
        $("#gameover button").click(function () {
          location.reload();
        });
        $("#container").click(handleClick);
      });
    </script>
  </head>
  <body>
    <div id="container">
      <div class="sliding-background"></div>
      <img id="player" src="playerR.png" alt="" />

      <img
        id="enemy"
        class="enemy"
        src="enemyL.png"
        alt=""
        data-direction="left"
        data-speed="2"
      />
      <img
        id="enemy2"
        class="enemy"
        src="enemyL.png"
        alt=""
        data-direction="right"
        data-speed="3"
      />
      <img
        id="enemy3"
        class="enemy"
        src="enemyL.png"
        alt=""
        data-direction="left"
        data-speed="4"
      />
    </div>
    <div id="gameover">
      GameOver
      <button id="button" onclick="location.reload()">확인</button>
    </div>
  </body>
</html>
